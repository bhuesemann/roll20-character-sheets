<!DOCTYPE html>

<input type='hidden' class='sheet-tabstoggle' name='attr_sheetTab'  value='character'/>

<div class='sheet-character'>
	<div>
		<button type="action" name="act_character" style='border-radius: 5px 5px 0px 0px; border-bottom-width: 0;' >Character</button>
		<button type="action" name="act_journal" style='border-radius: 5px 5px 0px 0px; border-bottom-width: 0; color: grey; background-color: white;'>Journal</button>
	</div>
	<div class="sheet-grid-section">
		<div class="sheet-namelvl sheet-block">
			<div class=sheet-label>
				<div> <!-- Always break -->
					<span class=sheet-first-word>Name</span>
					<input type=text style='width: 22em;' name="attr_cname"/>
					<span style='white-space:nowrap'>
						&nbsp;Age <input type=text style='width: 3em;'name="attr_age"/>
					</span>
				</div>
				<span style='white-space:nowrap'>
					&nbsp;Title/Rank <input type=text style='width: 7em;' name="attr_title"/>
				</span>
				<span style='white-space:nowrap'>
					&nbsp;Race <input type=text style='width: 8em;'name="attr_race"/>
				</span>
				<span style='white-space:nowrap'>
					&nbsp;Gender <input type=text style='width: 5em;' name="attr_gender"/>
				</span>
			</div>
		</div>
		<div class="sheet-stats sheet-block">
			<div> <!-- To prevent them from vertically spreading out -->
				<div style='white-space:nowrap'>
					<span class=sheet-stat-label>ST</span>
					<input class=sheet-stat-input type=number name="attr_ST_max" value="8"/>
					<span class=sheet-stat-plus>+</span>
					<input class=sheet-stat-input type=number title="Temporary adjustment to ST, not counting Wounds or Fatigue." name="attr_ST_adj" value="0"/>
					<span class=sheet-stat-equals>=</span>
					<span class=sheet-stat-final title="Final ST.  Base plus Adjustments, not counting Wounds or Fatigue." name="attr_ST"/>
					&nbsp;
					<button class=sheet-dice-button type="action" name="act_st_check3">3</button>
					<button class=sheet-dice-button type="action" name="act_st_check4">4</button>
				</div>
				<div style='white-space:nowrap'>
					<span class=sheet-stat-label>DX</span>
					<input class=sheet-stat-input type=number name="attr_DX_max" value="8"/>
					<span class=sheet-stat-plus>+</span>
					<input class=sheet-stat-input type=number title="Temporary adjustment to DX." name="attr_DX_adj" value="0"/>
					<span class=sheet-stat-equals>=</span>
					<span class=sheet-stat-final title="Final DX.  Base plus Adjustments minus Dex Penalties." name="attr_DX"/>
					&nbsp;
					<button class=sheet-dice-button type="action" name="act_dx_check3">3</button>
					<button class=sheet-dice-button type="action" name="act_dx_check4">4</button>
				</div>
				<div style='white-space:nowrap'>
					<span class=sheet-stat-label>IQ</span>
					<input class=sheet-stat-input type=number name="attr_IQ_max" value="8"/>
					<span class=sheet-stat-plus>+</span>
					<input class=sheet-stat-input type=number title="Temporary adjustment to IQ." name="attr_IQ_adj" value="0"/>
					<span class=sheet-stat-equals>=</span>
					<span class=sheet-stat-final title="Final IQ.  Base plus Adjustments." name="attr_IQ"/>
					&nbsp;
					<button class=sheet-dice-button type="action" name="act_iq_check3">3</button>
					<button class=sheet-dice-button type="action" name="act_iq_check4">4</button>
				</div>
				<div style='white-space:nowrap'>
					<span class=sheet-stat-label>MA</span>
					<input class=sheet-stat-input type=number name="attr_MA_max" value="10"/>
					<span class=sheet-stat-plus>+</span>
					<input class=sheet-stat-input type=number title="Temporary adjustment to MA." name="attr_MA_adj" value="0"/>
					<span class=sheet-stat-equals>=</span>
					<span class=sheet-stat-final title="Final MA.  Base plus Adjustments." name="attr_MA"/>
				</div>
				<div style='white-space:nowrap'>
					&nbsp;<span class=sheet-label title="Weight carried and penalty.">Carrying</span>
					<span class=sheet-stat-final title="Total weight carried."name="attr_weightcarried"></span>
					<span class=sheet-label title="Weight penalty, automatically applied." name="attr_mapenalty"></span>
				</div>
				<div style='white-space:nowrap'>
					<span class=sheet-stat-label title="Max Staff Mana.">Mana</span>
					<input class=sheet-stat-input title="Max Staff Mana." type=number name="attr_mana_max" value="0"/>
					<span class=sheet-stat-plus title="How much Mana spent.">-</span>
					<input class=sheet-stat-input title="How much Mana spent." type=number name="attr_mana_adj" value="0"/>
					<span class=sheet-stat-equals>=</span>
					<span class=sheet-stat-final title="Remaining Mana." type=number name="attr_mana"></span>
				</div>
			</div>
		</div>
		<div class="sheet-combat sheet-block">
			<div> <!-- just to stop from wrapping -->
				<div>
					<button type=roll title="Add yourself to Turn Order." value="&{template:initiative} {{character_name=@{character_name}}} {{initiative=[[@{DX}[DEX] &{tracker}]]}}"><b style='font-size: .8em;'>Initiative</b></button>
				</div>
				<div style='white-space:nowrap'>
					<span class=sheet-label style='width: 7em;'>
						<span class=sheet-first-word title="Current Strength adjusted by Wounds and Fatigue.">Health</span>
					</span>
					<span class=sheet-stat-final name="attr_stcurrent"/>
				</div>
				<div style='white-space:nowrap'>
					<span class=sheet-label style='width: 7em;' title="Subtracted from enemy dex when attacking you.">Minus to Hit</span>
					<span class=sheet-stat-final name="attr_minustohit"/>
				</div style='white-space:nowrap'>
				<div>
					<span class=sheet-label style='width: 7em;' title="Hits blocked per attack by your armor/shields/abilities.">Hits Blocked</span>
					<span class=sheet-stat-final name="attr_totalblock"/>
				</div style='white-space:nowrap'>
				<div>
					<span class=sheet-label style='width: 7em;' title="Damage done to your Health, must be healed.">Wounds</span>
					<input type=number style='width: 3.5em;' name="attr_Hits" value="0"/>
				</div>
				<div style='white-space:nowrap'>
					<span class=sheet-label style='width: 7em;' title="Temporary damage done to your Health as for spellcasting.">Fatigue</span>
					<input type=number style='width: 3.5em;' name="attr_Fatigue" value="0"/>
				</div>
			</div>
		</div>
		<div class="sheet-talents sheet-block">
			<div> <!-- to keep it all together, not spread out vertically -->
				<div class=sheet-fieldset-header>
					<span class=sheet-first-word style='width: 14rem'>Talent</span>
				</div>
				<fieldset class=repeating_talents>
					<div class=sheet-flex-section>
						<input type=text name=attr_talentname class=sheet-flex>
						&nbsp;
						<button class="sheet-describe-button" title="Describe the talent." type="action" name="act_describe"/>
						<button class="sheet-expand-button" title="Expand and edit more fields." type="action" name="act_expand"/>
					</div>
					<input type="checkbox" name="attr_options-flag" hidden class="sheet-toggle">
					<div class="sheet-toggle-checked" style='margin-left: 1em; width: 90%'>
						<div>
							<span title="IQ required to use this talent.">IQ Required: </span>
							<input type=number name=attr_talentiq value="8">
						</div>
						<div>
							<span title="IQ points paid, if any, for this talent. Adds to Spent IQ Points.">IQ Spent: </span>
							<input type=number name="attr_talentcost">
						</div>
						<div>
							<span title="Experience points paid, if any, for this talent. Adds to Spent Experience Points.">Experience Spent: </span>
							<input type=number style='width: 5em' name="attr_expspent">
						</div>
						<span title="Description that shows when you click the Describe button.">Description:</span>
						<textarea class=sheet-text-area name="attr_description"></textarea>
					</div>
				</fieldset>
				<div sheet-fieldset-header style='white-space:nowrap'>
					<span title="IQ you have to spend on Talents or Spells.">IQ Unspent </span>
					<span class=sheet-stat-final name="attr_iqunspent"/>
				</div>
			</div>
		</div>
		<div class="sheet-attack sheet-block">
			<div>
				<span class="sheet-label sheet-first-word" title="Roll to attack with selected Weapon or Spell at a given to-hit value.">Attack!&nbsp;</span>
				<button class=sheet-attack-button type="action" name="act_attack-6">-6</button>
				<button class=sheet-attack-button type="action" name="act_attack-5">-5</button>
				<button class=sheet-attack-button title="Ranged at Prone behind cover" type="action" name="act_attack-4">-4</button>
				<button class=sheet-attack-button type="action" name="act_attack-3">-3</button>
				<button class=sheet-attack-button title="Several Wounded last turn" type="action" name="act_attack-2">-2</button>
				<button class=sheet-attack-button type="action" name="act_attack-1">-1</button>
				<button class=sheet-attack-button type="action" name="act_attack0">0</button>
				<button class=sheet-attack-button type="action" name="act_attack1">1</button>
				<button class=sheet-attack-button title="Flank Attack" type="action" name="act_attack2">2</button>
				<button class=sheet-attack-button type="action" name="act_attack3">3</button>
				<button class=sheet-attack-button title="Rear Attack" type="action" name="act_attack4">4</button>
				<button class=sheet-attack-button type="action" name="act_attack5">5</button>
				<button class=sheet-attack-button type="action" name="act_attack5">6</button>
			</div>
		</div>
		<div class="sheet-weapons sheet-block">
			<div class='sheet-fieldset-header sheet-flex-section'>
				<span class=sheet-first-word style='width: 12.5rem;'>Weapon</span>
				<span style='width: 6rem;'>Damage</span>
				<span style='width: 4rem;' title="Dex adjustment to hit an enemy.">To Hit</span>
				<span class=sheet-flex>Notes</span>
				<span style='width: 4rem;' title="Weight per item.">Lbs</span>
				<span style='width: 2rem;' title="Not carried, won't count as weight.">NC</span>
				<span class=sheet-flex-buttons-stub />
			</div>
			<fieldset class=repeating_weapons>
				<div class=sheet-flex-section>
					<input title="Select this Weapon for Attack!" type="checkbox" class=sheet-flex-checkbox name="attr_selected">
					<input type=text name=attr_weaponname style='width: 10rem;'>
					<input type=text name=attr_weapondamage style='width: 6rem;'>
					<input type=text name=attr_tohit style='width: 4rem;'>
					<input type=text name=attr_weaponnotes class=sheet-flex>
					<input type=text name=attr_weight style='width: 4rem;'>
					<input type="checkbox" name="attr_notcarried" value="1" class=sheet-flex-checkbox>
					&nbsp;
					<button class=sheet-describe-button title="Describe the weapon." type="action" name="act_describe"/>
					<button class=sheet-expand-button title="Expand and edit more fields in the selected weapon." type="action" name="act_expand"/>
				</div>
				<input type="checkbox" name="attr_options-flag" hidden class="sheet-toggle">
				<div class="sheet-toggle-checked sheet-expanded">
					<span title="Text shown when attacking, e.g. 'swings his mighty war axe.'">Flavor Text:</span>
					<input type=text name="attr_flavor" style='display: block; width:100%'>
					<span title="Details about the weapon, quoted with the Describe button.">Description:</span>
					<textarea class=sheet-text-area name="attr_description"></textarea>
				</div>
			</fieldset>
		</div>
		<div class="sheet-spells sheet-block">
			<div class='sheet-fieldset-header sheet-flex-section'>
				<span class=sheet-first-word style='width: 12.5rem;'>Spell</span>
				<span style='width: 6rem;'>Damage</span>
				<span style='width: 4rem;' title="Dex adjustment to hit an enemy.">To Hit</span>
				<span style='width: 7rem;' title="Strength cost when casting.">ST Cost</span>
				<span class=sheet-flex>Notes</span>
				<span class=sheet-flex-buttons-stub />
			</div>
			<fieldset class=repeating_spells>
				<div class=sheet-flex-section>
					<input title="Select this Spell for Attack!" type="checkbox" class=sheet-flex-checkbox name="attr_selected">
					<input type=text name=attr_spellname style='width: 10rem;'>
					<input type=text name=attr_spelldamage style='width: 6rem;'>
					<input type=text name=attr_tohit style='width: 4rem;'>
					<input type=text name=attr_stcost style='width: 7rem;'>
					<input type=text name=attr_spellnotes class=sheet-flex>
					&nbsp;
					<button class=sheet-describe-button title="Describe the spell." type="action" name="act_describe"/>
					<button class=sheet-expand-button title="Expand and edit more fields." type="action" name="act_expand"/>
				</div>
				<input type="checkbox" name="attr_options-flag" hidden class="sheet-toggle">
				<div class="sheet-toggle-checked sheet-expanded">
					<div>
						<span title="IQ required to get and cast this Spell.">IQ Required: </span>
						<input type=number name=attr_iqrequired value="8">
					</div>
					<div>
						<span title="IQ points paid, if any, for this spell. Adds to Spent IQ Points.">IQ Spent: </span>
						<input type=number name="attr_spellcost">
					</div>
					<div>
						<span title="Experience points paid, if any, for this talent. Adds to Spent Experience Points.">Experience Spent: </span>
						<input type=number style='width: 5em' name="attr_expspent">
					</div>
					<div>
						<span title="Text that displays when the spell succeeds.">Flavor Text:</span>
						<input type=text name="attr_flavor" style='display: block; width:100%'>
					</div>
					<div title="Description that shows when you click the Describe button.">Description:</div>
					<textarea class=sheet-text-area name="attr_description"></textarea>
				</div>
			</fieldset>
		</div>
		<div class="sheet-armor sheet-block">
			<div class='sheet-fieldset-header sheet-flex-section'>
				<span class=sheet-first-word style='width: 13rem;'>Armor or Shield</span>
				<span style='width: 5rem;' title="Damage absorbed per attack.">Hits Blocked</span>
				<span style='width: 5rem;' title="Subtracted from opponent's Dex when they attack.">Minus to Hit</span>
				<span style='width: 5rem;' title="Subtracted from your Dex.">Dex Penalty</span>
				<span class=sheet-flex>Notes</span>
				<span style='width: 4rem;' title="Weight of armor/shield.">Lbs</span>
				<span style='width: 2rem;' title="Not carried, won't count as weight.">NC</span>
				<span class=sheet-flex-buttons-stub />
			</div>
			<fieldset class=repeating_armor>
				<div class=sheet-flex-section>
					<input type=text name=attr_defensename value="" style='width: 13rem;'>
					<input type=text name=attr_hitsblocked value="0" style='width: 5rem;'>
					<input type=text name=attr_minustohit value="0" style='width: 5rem;'>
					<input type=text name=attr_dexpenalty value="0" style='width: 5rem;'>
					<input type=text name=attr_defensenotes class=sheet-flex>
					<input type=text name=attr_weight value="" style='width: 4rem;'>
					<input type="checkbox" name="attr_notcarried" value="1" class=sheet-flex-checkbox>
					&nbsp;
					<button class=sheet-describe-button title="Describe the Armor/Shield." type="action" name="act_describe"/>
					<button class=sheet-expand-button title="Expand and edit more fields." type="action" name="act_expand"/>
				</div>
				<input type="checkbox" name="attr_options-flag" hidden class="sheet-toggle">
				<div class="sheet-toggle-checked sheet-expanded">
					<div title="Description that shows when you click the Describe button.">Description:</div>
					<textarea class=sheet-text-area name="attr_description"></textarea>
				</div>
			</fieldset>
		</div>
		<div class="sheet-equip sheet-block">
			<div class='sheet-fieldset-header sheet-flex-section'>
				<span class=sheet-first-word style='width: 13rem'>Equipment</span>
				<span style='width: 5rem;'>Count</span>
				<span class=sheet-flex>Notes</span>
				<span style='width: 4rem;' title="Weight per item.">Lbs</span>
				<span style='width: 2rem;' title="Not carried, won't count as weight.">NC</span>
				<span class=sheet-flex-buttons-stub />
			</div>
			<fieldset class=repeating_equipment>
				<div class=sheet-flex-section>
					<input type=text name=attr_name style='width: 13rem;'>
					<input type=number name=attr_count value="1" style='width: 5rem;'>
					<input type=text name=attr_notes class=sheet-flex>
					<input type=text name=attr_weight value="" style='width: 4rem;'>
					<input type=checkbox name=attr_notcarried value="1" class=sheet-flex-checkbox>
					&nbsp;
					<button class=sheet-describe-button title="Describe the Equipment." type="action" name="act_describe"/>
					<button class=sheet-expand-button title="Expand and edit more fields." type="action" name="act_expand"/>
				</div>
				<input type="checkbox" name="attr_options-flag" hidden class="sheet-toggle">
				<div class="sheet-toggle-checked sheet-expanded">
					<div title="Description that shows when you click the Describe button.">Description:</div>
					<textarea class=sheet-text-area name="attr_description"></textarea>
				</div>
			</fieldset>
		</div>
	</div>
</div>
<div class='sheet-journal'>
	<div>
		<button type="action" name="act_character" style='border-radius: 5px 5px 0px 0px; border-bottom-width: 0; color: grey; background-color: white;' >Character</button>
		<button type="action" name="act_journal" style='border-radius: 5px 5px 0px 0px; border-bottom-width: 0; '>Journal</button>
	</div>
	<div class="sheet-grid-section-journal">
		<div class="sheet-pointhistory sheet-block">
			<label>Experience</label>
			<span class=sheet-label>
				<div style='margin-bottom: .5em'>
					<span title="Total amount of experience the character has ever gained.">Experience Total</span>
					<input type=number style='width: 6em;' name="attr_experiencetotal" value="0"/>
					&nbsp
					<span title="Total Experience spent on Attributes, Talents, and Spells.">Spent <span class=sheet-stat-final name="attr_experiencespent"/></span>
					&nbsp
					<span title="Experience you can spend on Attributes, Talents, or Spells.">Unspent <span class=sheet-stat-final name="attr_experienceunspent"/></span>
				</div>
			</span>
			<br>
			<div class='sheet-fieldset-header sheet-flex-section'>
				<span style='width: 12rem;' title="Put abilities that you buy here, to track the experience cost.">Attribute Acquired</span>
				<span style='width: 8rem;'>Exp Spent</span>
				<span class=sheet-flex>Notes</span>
			</div>
			<fieldset class=repeating_exphistory>
				<div class=sheet-flex-section>
					<input type=text name=attr_expability style='width: 12rem;'>
					<input type=number name=attr_expspent style='width: 8rem;'>
					<input type=text name=attr_expnotes class=sheet-flex>
				</div>
			</fieldset>
		</div>
		<div class="sheet-notes sheet-block">
			<label>Notes</label>
			<textarea class=sheet-text-area name="attr_inventory" title="Notes"></textarea>
		</div>
		</div>
		<div class="sheet-otherspells sheet-block">
			<label>Other Spells and Talents</label>
			<textarea class=sheet-text-area name="attr_spells" title="Spells"></textarea>
		</div>
	</div>
</div>


<rolltemplate class="sheet-rolltemplate-stat-check3">
	<div class=container>
		<div><h1>{{character_name}} makes {{stat_a}}
			<span style='text-transform: capitalize'>{{stat_name}}</span>
			check.
		</h1></div>
		<div class=arrow-container><div class=arrow-right></div></div>
		<div>
			<span class=template-dice>{{computed::roll1}}</span>
			= {{roll1}} vs {{stat}}
		</div>
		{{#rollTotal() roll1 18}}
			<div class=failure>Critical Failure!</div>
		{{/rollTotal() roll1 18}}
		{{#rollTotal() roll1 17}}
			<div class=failure>Critical Failure!</div>
		{{/rollTotal() roll1 17}}
		{{#rollTotal() roll1 16}}
			<div class=failure>Automatic Failure!</div>
		{{/rollTotal() roll1 16}}
		{{#rollTotal() roll1 3}}
			<div class=success>Critical Success!!</div>
		{{/rollTotal() roll1 3}}
		{{#rollTotal() roll1 4}}
			<div class=success>Critical Success!</div>
		{{/rollTotal() roll1 4}}
		{{#rollTotal() roll1 5}}
			<div class=success>Automatic Success!</div>
		{{/rollTotal() roll1 5}}
		{{#rollBetween() roll1 6 15}}
			{{#^rollGreater() roll1 stat}}
				<div class=success>Success!</div>
			{{/^rollGreater() roll1 stat}}
			{{#rollGreater() roll1 stat}}
				<div class=failure>Failure!</div>
			{{/rollGreater() roll1 stat}}
		{{/rollBetween() roll1 6 15}}
	</div>
</rolltemplate>

<rolltemplate class="sheet-rolltemplate-stat-check4">
	<div class=container>
		<div><h1>{{character_name}} makes {{stat_a}}
			<span style='text-transform: capitalize'>{{stat_name}}</span>
			check.
		</h1></div>
		<div class=arrow-container><div class=arrow-right></div></div>
		<div>
			<span class=template-dice>{{computed::roll1}}</span>
			= {{roll1}} vs {{stat}}
		</div>
		{{#rollTotal() roll1 24}}
			<div class=failure>Critical Failure!!!!</div>
		{{/rollTotal() roll1 24}}
		{{#rollTotal() roll1 23}}
			<div class=failure>Critical Failure!!!</div>
		{{/rollTotal() roll1 23}}
		{{#rollTotal() roll1 22}}
			<div class=failure>Critical Failure!!</div>
		{{/rollTotal() roll1 22}}
		{{#rollTotal() roll1 21}}
			<div class=failure>Critical Failure!</div>
		{{/rollTotal() roll1 21}}
		{{#rollTotal() roll1 20}}
			<div class=failure>Automatic Failure!</div>
		{{/rollTotal() roll1 20}}
		{{#rollTotal() roll1 4}}
			<div class=success>Critical Success!!!!</div>
		{{/rollTotal() roll1 4}}
		{{#rollTotal() roll1 5}}
			<div class=success>Critical Success!!!</div>
		{{/rollTotal() roll1 5}}
		{{#rollTotal() roll1 6}}
			<div class=success>Critical Success!!</div>
		{{/rollTotal() roll1 6}}
		{{#rollTotal() roll1 7}}
			<div class=success>Critical Success!</div>
		{{/rollTotal() roll1 7}}
		{{#rollTotal() roll1 8}}
			<div class=success>Automatic Success!</div>
		{{/rollTotal() roll1 8}}
		{{#rollBetween() roll1 9 19}}
			{{#^rollGreater() roll1 stat}}
				<div class=success>Success!</div>
			{{/^rollGreater() roll1 stat}}
			{{#rollGreater() roll1 stat}}
				<div class=failure>Failure!</div>
			{{/rollGreater() roll1 stat}}
		{{/rollBetween() roll1 9 19}}
	</div>
</rolltemplate>

<!-- For an attack -->
<rolltemplate class="sheet-rolltemplate-attack">
	<div class=container>
		<div><h1>
			{{#flavor}}
				{{character_name}} {{flavor}}
			{{/flavor}}
			{{^flavor}}
				{{character_name}} attacks with {{pronoun}} {{weaponname}}!
			{{/flavor}}
		</h1></div>
		<div class=arrow-container><div class="arrow-right"></div></div>
		<div>
			<span class=template-dice>{{computed::roll1}}</span>
			= {{roll1}} vs {{tohit}}
		</div>
		{{#rollTotal() roll1 18}}
			<div class=failure>Critical miss, weapon breaks!</div>
		{{/rollTotal() roll1 18}}
		{{#rollTotal() roll1 17}}
			<div class=failure>Critical miss, drop weapon!</div>
		{{/rollTotal() roll1 17}}
		{{#rollTotal() roll1 16}}
			<div class=failure>Automatic miss!</div>
		{{/rollTotal() roll1 16}}
		{{#rollTotal() roll1 3}}
			<div class=success>Critical hit, triple Damage!</div>
			{{#damage}}
				<div class=keyvalue><span>Damage: </span>{{damage}}</div>
			{{/damage}}
		{{/rollTotal() roll1 3}}
		{{#rollTotal() roll1 4}}
			<div class=success>Critical hit, double Damage!</div>
			{{#damage}}
				<div class=keyvalue><span>Damage: </span>{{damage}}</div>
			{{/damage}}
		{{/rollTotal() roll1 4}}
		{{#rollTotal() roll1 5}}
			<div class=success>Automatic hit!</div>
			{{#damage}}
				<div class=keyvalue><span>Damage: </span>{{damage}}</div>
			{{/damage}}
		{{/rollTotal() roll1 5}}
		{{#rollBetween() roll1 6 15}}
			{{#^rollGreater() roll1 tohit}}
				<div class=success>Hit!</div>
				{{#damage}}
					<div class=keyvalue><span>Damage: </span>{{damage}}</div>
				{{/damage}}
			{{/^rollGreater() roll1 tohit}}
			{{#rollGreater() roll1 tohit}}
				<div class=failure>Miss!</div>
			{{/rollGreater() roll1 tohit}}
		{{/rollBetween() roll1 6 15}}
	</div>
</rolltemplate>


<!-- For casting a spell -->
<rolltemplate class="sheet-rolltemplate-cast-spell">
	<div class=container>
		<div><h1>{{character_name}} casts {{spellname}}!</h1></div>
		<div class=arrow-container><div class=arrow-right></div></div>
		<div>
			<span class=template-dice>{{computed::roll1}}</span>
			= {{roll1}} vs {{tohit}}
		</div>
		{{#rollTotal() roll1 18}}
			<div class=failure>Critical Failure, staff breaks!</div>
		{{/rollTotal() roll1 18}}
		{{#rollTotal() roll1 17}}
			<div class=failure>Critical Failure, lose ST, drop staff!</div>
		{{/rollTotal() roll1 17}}
		{{#rollTotal() roll1 16}}
			<div class=failure>Automatic Failure!</div>
		{{/rollTotal() roll1 16}}
		{{#rollTotal() roll1 3}}
			{{#flavor}}
				<div class=description>{{flavor}}</div>
			{{/flavor}}
			<div class=success>Critical Success, triple Damage or Effect!</div>
			{{#damage}}
				<div>Damage: {{damage}}</div>
			{{/damage}}
		{{/rollTotal() roll1 3}}
		{{#rollTotal() roll1 4}}
			<div class=success>Critical Success, double Damage or Effect!</div>
			{{#flavor}}
				<div class=description>{{flavor}}</div>
			{{/flavor}}
			{{#damage}}
				<div class=keyvalue><span>Damage: </span>{{damage}}</div>
			{{/damage}}
		{{/rollTotal() roll1 4}}
		{{#rollTotal() roll1 5}}
			<div class=success>Automatic Success!</div>
			{{#flavor}}
				<div class=description>{{flavor}}</div>
			{{/flavor}}
			{{#damage}}
				<div class=keyvalue><span>Damage: </span>{{damage}}</div>
			{{/damage}}
		{{/rollTotal() roll1 5}}
 		{{#rollBetween() roll1 6 15}}
			{{#^rollGreater() roll1 tohit}}
				<div class=success>Success!</div>
				{{#flavor}}
					<div class=description>{{flavor}}</div>
				{{/flavor}}
				{{#damage}}
					<div class=keyvalue><span>Damage: </span>{{damage}}</div>
				{{/damage}}
			{{/^rollGreater() roll1 tohit}}
			{{#rollGreater() roll1 tohit}}
				<div class=failure>Failure!</div>
				{{#damage}}
					<div class=keyvalue><span style='color:gray'>Damage: </span>{{damage}}</div>
				{{/damage}}
			{{/rollGreater() roll1 tohit}}
		{{/rollBetween() roll1 6 15}}
	</div>
</rolltemplate>


<!-- For initiative, just nice to have a template -->
<rolltemplate class="sheet-rolltemplate-initiative">
	<div class=container>
		<div><h1>
			{{character_name}} takes initiative!
		</h1></div>
		<div class=arrow-container><div class=arrow-right></div></div>
		<div class=keyvalue>
			<span>Dexterity: </span><span>{{initiative}}</span>
		</div>
	</div>
</rolltemplate>


<!-- For Descriptions, just nice to have a template -->
<rolltemplate class="sheet-rolltemplate-description">
	<div class=container>
		<div><h1>
			<span style='text-transform: capitalize'>{{item_name}}</span>
		</h1></div>
		<div class=arrow-container><div class=arrow-right></div></div>
		{{#stat0}}
			<div class=keyvalue><span>{{name0}}: </span><span>{{stat0}}</span></div>
		{{/stat0}}
		{{#stat1}}
			<div class=keyvalue><span>{{name1}}: </span><span>{{stat1}}</span></div>
		{{/stat1}}
		{{#stat2}}
			<div class=keyvalue><span>{{name2}}: </span><span>{{stat2}}</span></div>
		{{/stat2}}
		{{#stat3}}
			<div class=keyvalue><span>{{name3}}: </span><span>{{stat3}}</span></div>
		{{/stat3}}
		{{#stat4}}
			<div class=keyvalue><span>{{name4}}: </span><span>{{stat4}}</span></div>
		{{/stat4}}
		{{#stat5}}
			<div class=keyvalue><span>{{name5}}: </span>{{stat5}}</div>
		{{/stat5}}
			<div class=description><span>{{description}}</span></div>
		</div>
	</div>
</rolltemplate>

<script type="text/worker">

	// just concats to make a property name.
	const repeatingPropertyName = function(repName, id, itemName) {
		return `repeating_${repName}_${id}_${itemName}`;
	}

	// Safe method to get a repeating property.
	const getFloatProperty = function(v, repName, id, itemName) {
		let property = repeatingPropertyName(repName, id, itemName);
		let val = parseFloat(v[property]);
		return isNaN(val) ? 0 : val;
	}

	// to compute the total we need the object,
	// the ids, the repName, and various itemnames.
	const computeRepeatingTotal = function(v, idarray, repName, weightName, countName, notCarriedName) {
		 let total = 0
		for(var i=0; i < idarray.length; i++) {
			let id = idarray[i]
			let value = getFloatProperty(v, repName, id, weightName);
			if (countName) {
				value *= getFloatProperty(v, repName, id, countName);
			}
			if (notCarriedName) {
				let notCarried = getFloatProperty(v, repName, id, notCarriedName);
				value *= (1.0 - notCarried);
			}
			total += value;
		}
		return total;
	}

	//e.g: "weapons" and "weaponwt"
	// postcallback takes attrs, idarray, repName, weightName, countName, notCarriedName
	let grabIds = function(idarray, repName, weightName, countName, notCarriedName, postcallback) {
		let attrs = [];
		for(var i=0; i < idarray.length; i++) {
			let id = idarray[i];
			attrs.push(repeatingPropertyName(repName, id, weightName));
			if (countName) {
				attrs.push(repeatingPropertyName(repName, id, countName));
			}
			if (notCarriedName) {
				let propertyName = repeatingPropertyName(repName, id, notCarriedName);
				attrs.push(propertyName);
			}
		}
		getAttrs(attrs, function(v) {
			postcallback(v, idarray, repName, weightName, countName, notCarriedName);
		});
	}

	const diceArrayToString = function(rolls) {
		let diceString = '';
		for (i = 0; i < rolls.length; ++i) {
			let roll = rolls[i];
			if (roll == 1) diceString += 'a';
			else if (roll == 2) diceString += 'b';
			else if (roll == 3) diceString += 'c';
			else if (roll == 4) diceString += 'd';
			else if (roll == 5) diceString += 'e';
			else diceString += 'f';

			if (i < rolls.length -1)
				diceString +=   '&#8239;' // '&thinsp;'

		}
		return diceString;
	}

	const finishRollWithDiceString = function(rolls, rollId) {
		let diceString = diceArrayToString(rolls);
		finishRoll(
			rollId,
			{
				roll1: diceString
			}
		);
	}
	// do the roll check and compute the dice string.
	const doRollWithDiceString = function(macro) {
		macro += ' {{character_name=@{cname}}}';
		startRoll(macro, (results) => {
			finishRollWithDiceString(results.results.roll1.dice, results.rollId);
		});
	}

	// calls back on this selected weapon or fails.
	// callback takes the id of the selected one, and all the ids.
	const onSelectedWeaponOrSpell = function(callback) {
		// find selected weapon, if any.
		getSectionIDs("weapons", function(sectionIds) {
			let selectedIds = [];
			for (var i = 0; i < sectionIds.length; ++i) {
				selectedIds.push(repeatingPropertyName('weapons', sectionIds[i], 'selected'));
			}
			getAttrs(selectedIds, function(values) {
				for (var i = 0; i < sectionIds.length; ++i) {
					let id = sectionIds[i];
					let selectedName  = repeatingPropertyName('weapons', id, 'selected');
					if (values[selectedName] == 'on') {
						callback(id, sectionIds, 'weapon');
						return;
					}
				}
				// must be a spell, not a weapon.
				getSectionIDs("spells", function(sectionIds) {
					let selectedIds = [];
					for (var i = 0; i < sectionIds.length; ++i) {
						selectedIds.push(repeatingPropertyName('spells', sectionIds[i], 'selected'));
					}
					getAttrs(selectedIds, function(values) {
						for (var i = 0; i < sectionIds.length; ++i) {
							let id = sectionIds[i];
							let selectedName  = repeatingPropertyName('spells', id, 'selected');
							if (values[selectedName] == 'on') {
								callback(id, sectionIds, 'spell');
								return;
							}
						}
					});
				});
			});
		});
	}

	// 	Describes an item, give it name, description attributes.
	// and a linear array of [name, attribute, ..] pairs.
	const describeItem = function(nameAttr, descriptionAttr, statArray) {
		let macro = '&{template:description}'
		+ ` {{item_name=@{${nameAttr}}}}`
		+ ` {{description=@{${descriptionAttr}}}}`;

		if (statArray) {
			for (var i = 0; i*2 < statArray.length; ++i) {
				let name = statArray[i*2];
				let attr = statArray[i*2 + 1];
				macro += ` {{name${i}=${name}}} {{stat${i}=@{${attr}}}}`;
			}
		}
		startRoll(macro, (results) => {
			finishRoll( results.rollId, {} );
		});
	}

	// Toggles the expansion of an item.  you need to give it repeating_X-Y for id.
	const toggleItem = function(id) {
		let optionsName = id + '_options-flag';
		getAttrs([optionsName], function(v) {
			let attrMap = {};
			attrMap[optionsName] = v[optionsName] == 0 ? 'on' : 0;
			setAttrs(attrMap, {silent: true});
		});
	}

	// Update Str
	on('sheet:opened change:st_max change:st_adj', function() {
		getAttrs(['st_max', 'st_adj'], function(v) {
			let finalStr = (parseInt(v.st_max)||0) + (parseInt(v.st_adj)||0);
			setAttrs({
				st: finalStr
			});
		});
	});

	// Update IQ
	on('sheet:opened change:iq_max change:iq_adj', function() {
		getAttrs(['iq_max', 'iq_adj'], function(v) {
			let finalIQ = (parseInt(v.iq_max)||0) + (parseInt(v.iq_adj)||0);
			setAttrs({
				iq: finalIQ
			});
		});
	});


	on('clicked:st_check3', (info) => {
		doRollWithDiceString("&{template:stat-check3} {{stat_a=a}} {{stat_name=strength}} {{stat=[[@{st}[STR]]]}} {{roll1=[[3d6]]}}");
	});
	on('clicked:st_check4', (info) => {
		doRollWithDiceString("&{template:stat-check4} {{stat_a=a}} {{stat_name=strength}} {{stat=[[@{st}[STR]]]}} {{roll1=[[4d6]]}}");
	});
	on('clicked:dx_check3', (info) => {
		doRollWithDiceString("&{template:stat-check3} {{stat_a=a}} {{stat_name=dexterity}} {{stat=[[@{dx}[DEX]]]}} {{roll1=[[3d6]]}}");
	});
	on('clicked:dx_check4', (info) => {
		doRollWithDiceString("&{template:stat-check4} {{stat_a=a}} {{stat_name=dexterity}} {{stat=[[@{dx}[DEX]]]}} {{roll1=[[4d6]]}}");
	});
	on('clicked:iq_check3', (info) => {
		doRollWithDiceString("&{template:stat-check3} {{stat_a=an}} {{stat_name=IQ}} {{stat=[[@{iq}[IQ]]]}} {{roll1=[[3d6]]}}");
	});
	on('clicked:iq_check4', (info) => {
		doRollWithDiceString("&{template:stat-check4} {{stat_a=an}} {{stat_name=IQ}} {{stat=[[@{iq}[IQ]]]}} {{roll1=[[4d6]]}}");
	});

	// new attack
	on('clicked:iq_check4', (info) => {
		doRollWithDiceString("&{template:stat-check4} {{stat_a=an}} {{stat_name=IQ}} {{stat=[[@{iq}[IQ]]]}} {{roll1=[[4d6]]}}");
	});

	/* TALENT HANDLERS */

	// Expand or describe a talent.
	on('clicked:repeating_talents', (info) => {
		let id = info.sourceAttribute;
		let name = info.htmlAttributes.name;
		if (name == 'act_describe') {
			describeItem(id + '_talentname', id + '_description');
		}
		else if (name == 'act_expand') {
			toggleItem(id);
		}
	});

	/* WEAPON HANDLERS */

	// Select a weapon.
	on('change:repeating_weapons:selected change:repeating_spells:selected' , (info) => {
		// get them all, and de check any not me...
		getSectionIDs("weapons", function(weaponIds) {
			getSectionIDs("spells", function(spellIds) {
				// Radio button them.
				let valueMap = {};
				for (var i = 0; i < weaponIds.length; ++i) {
					if (info.newValue == 'on') {
						let propertyName = repeatingPropertyName('weapons', weaponIds[i], 'selected');
						if (propertyName != info.triggerName) {
							valueMap[propertyName] = 0;
						}
					}
				}
				for (var i = 0; i < spellIds.length; ++i) {
					if (info.newValue == 'on') {
						let propertyName = repeatingPropertyName('spells', spellIds[i], 'selected');
						if (propertyName != info.triggerName) {
							valueMap[propertyName] = 0;
						}
					}
				}
				setAttrs(valueMap, {silent: true});
			});
		});
	});

	// Weapon Attack Buttons.
	on('clicked:attack-5'
	+ ' clicked:attack-4'
	+ ' clicked:attack-3'
	+ ' clicked:attack-2'
	+ ' clicked:attack-1'
	+ ' clicked:attack0'
	+ ' clicked:attack1'
	+ ' clicked:attack2'
	+ ' clicked:attack3'
	+ ' clicked:attack4'
	+ ' clicked:attack5', (info) => {
		let toHit = parseInt(info.triggerName.substring(14))||0;

		onSelectedWeaponOrSpell(function(id, selectedIds, type) {

			if (type == 'weapon') {
				let flavorName = repeatingPropertyName('weapons', id, 'flavor');
				let weaponToHitName  = repeatingPropertyName('weapons', id, 'tohit');
				let weaponDamageName = repeatingPropertyName('weapons', id, 'weapondamage');
				getAttrs(['gender', flavorName, weaponToHitName, weaponDamageName], function(v) {
					let mstring  = `&{template:attack}`
						+ ` {{weaponname=@{${repeatingPropertyName('weapons', id, 'weaponname')}}}}`
						+ ` {{roll1=[[3d6]]}}`;

					{ // compute to hit.
						mstring += ' {{tohit=[[@{DX}[DEX]';
						// provisionally add weapon toHit.
						if (parseInt(v[weaponToHitName])||0) {
							mstring += ` + @{${weaponToHitName}}[WPN_ADJ]`;
						}
						// and to hit.
						if (toHit != 0) {
							mstring += ` + ${toHit}[TOHIT]`;
						}
						// and finish.
						mstring += ']]}}';
					}

					// conditionally add damage
					if (v[weaponDamageName] != '' && v[weaponDamageName] != '0') {
						mstring += ` {{damage=[[@{${weaponDamageName}}]]}}`;
					}

					{ // add pronoun.
						let gender = v.gender.toLowerCase();
						let pronoun = 'their';
						if (gender == 'male') pronoun = 'his';
						else if (gender == 'female') pronoun = 'her'
						mstring += ` {{pronoun=${pronoun}}}`;
					}

					if (v[flavorName] != '') {
						mstring += ` {{flavor=@{${flavorName}}}}`;
					}
					doRollWithDiceString(mstring);
				});
			} else if (type == 'spell') {
				let damageName = repeatingPropertyName('spells', id, 'spelldamage');
				let flavorName = repeatingPropertyName('spells', id, 'flavor');
				let toHitName  = repeatingPropertyName('spells', id, 'tohit');
				getAttrs([flavorName, toHitName, damageName], function(v) {
					let mstring  = `&{template:cast-spell}`
						+ ` {{spellname=@{${repeatingPropertyName('spells', id, 'spellname')}}}}`
						+ ' {{roll1=[[3d6]]}}';

					{ // compute to hit
						mstring += '{{tohit=[[@{DX}[DEX]';
						// provisionally add spell toHit.
						if (parseInt(v[toHitName])||0) {
							mstring += ` + @{${toHitName}}[SPELL_ADJ]`;
						}
						// and rolled to hit.
						if (toHit != 0) {
							mstring += ` + ${toHit}[TOHIT]`;
						}
						// and finish.
						mstring += ']]}}';
					}
					if (v[damageName] != '' && v[damageName] != '0') {
						mstring += ` {{damage=[[@{${damageName}}]]}}`;
					}
					if (v[flavorName] != '') {
						mstring += ` {{flavor=@{${flavorName}}}}`;
					}
					doRollWithDiceString(mstring);
				});
			}
		});
	});

	// Weapons Expand/Describe
	on('clicked:repeating_weapons', (info) => {
		let name = info.htmlAttributes.name;
		let id = info.sourceAttribute;
		if (name == 'act_describe') {
			describeItem(id + '_weaponname', id + '_description',
				['To Hit', id + '_tohit'
				, 'Damage', id + '_weapondamage'
				, 'Weight', id + '_weight'
				, 'Notes', id + '_weaponnotes']);
		}
		else if (name == 'act_expand') {
			toggleItem(id);
		}
	});


	/* Spell Handlers */

	// Update Mana
	on('sheet:opened change:mana_max change:mana_adj', function() {
		getAttrs(['mana_max', 'mana_adj'], function(v) {
			let finalMana = (parseInt(v.mana_max)||0) - (parseInt(v.mana_adj)||0);
			setAttrs({
				mana: finalMana
			});
		});
	});


	// Spell Cast/Expand/Describe
	on('clicked:repeating_spells', (info) => {
		let name = info.htmlAttributes.name;
		let id = info.sourceAttribute;
		 if (name == 'act_describe') {
			describeItem(id + '_spellname', id + '_description',
				['To Hit', id + '_tohit',
				'Damage', id + '_spelldamage',
				'ST Cost', id + '_stcost',
				'Notes', id + '_spellnotes'
				]);
		}
		else if (name == 'act_expand') {
			toggleItem(id);
		}
	});

	/* Armor Handlers */
	// Expand or describe a talent.
	on('clicked:repeating_armor', (info) => {
		let id = info.sourceAttribute;
		let name = info.htmlAttributes.name;
		if (name == 'act_describe') {
			describeItem(id + '_defensename', id + '_description',
				['Hits Blocked', id + '_hitsblocked',
				'Minus to Hit', id + '_minustohit',
				'DX Penalty', id + '_dexpenalty',
				'Weight', id + '_weight',
				'Notes', id + '_defensenotes']);
		}
		else if (name == 'act_expand') {
			toggleItem(id);
		}
	});

	/* Equipment Handlers */
	// Expand or describe a talent.
	on('clicked:repeating_equipment', (info) => {
		let id = info.sourceAttribute;
		let name = info.htmlAttributes.name;
		if (name == 'act_describe') {
			describeItem(id + '_name', id + '_description',
				['Count', id + '_count',
				'Weight', id + '_weight',
				'Notes', id + '_notes'
				]);
		}
		else if (name == 'act_expand') {
			toggleItem(id);
		}
	});


	/* Experience Handlers */

	// Update experience spent and unspent.
	// need to sum from three sources.
	on('sheet:opened change:experiencetotal'
	+ ' change:repeating_exphistory remove:repeating_exphistory'
	+ ' change:repeating_spells remove:repeating_spells'
	+ ' change:repeating_talents remove:repeating_talents', function() {
		let totalSpent = 0;
		let totalCallbacks = 0;

		let idCallback = function(attrs, idarray, repName, spentName) {
			totalSpent += computeRepeatingTotal(attrs, idarray, repName, spentName);
			if (++totalCallbacks == 3) {
				getAttrs(["experiencetotal"], function(v) {
					let total = parseInt(v.experiencetotal)||0;
					setAttrs({
						experienceunspent: (total - totalSpent),
						experiencespent: totalSpent
					})
				});
			}
		}
		getSectionIDs("exphistory", function(v) {grabIds(v, 'exphistory', 'expspent', '', '', idCallback);});
		getSectionIDs("talents", function(v) {grabIds(v, 'talents', 'expspent', '', '', idCallback);});
		getSectionIDs("spells", function(v) {grabIds(v, 'spells', 'expspent', '', '', idCallback);});
	});

	/* Armor Handlers */

	// Update Hits Blocked
	on('sheet:opened change:repeating_armor remove:repeating_armor', function() {
		let idCallback = function(attrs, idarray, repName, blockedName, countName, notCarriedName) {
			let totalBlocked = computeRepeatingTotal(attrs, idarray, repName, blockedName, countName, notCarriedName);
			setAttrs({
				totalblock: totalBlocked
			});
		}
		getSectionIDs("armor", function(v) {grabIds(v, 'armor', 'hitsblocked', '', 'notcarried', idCallback);});
	});

	// Update Minus to Hit
	on('sheet:opened change:repeating_armor remove:repeating_armor', function() {
		let idCallback = function(attrs, idarray, repName, minusToHitName, countName, notCarriedName) {
			let totalMinus = computeRepeatingTotal(attrs, idarray, repName, minusToHitName, countName, notCarriedName);
			setAttrs({
				minustohit: totalMinus
			});
		}
		getSectionIDs("armor", function(v) {grabIds(v, 'armor', 'minustohit', '', 'notcarried', idCallback);});
	});


	on('sheet:opened change:st change:hits change:fatigue', function() {
		getAttrs(['st', 'hits', 'fatigue'], function(v) {
			let hitpoints = v.st - v.hits - v.fatigue;
			setAttrs({
				stcurrent: hitpoints
			});
		});
	});

	// Update weight carried and penalty, and MA
	on('sheet:opened'
		+ ' change:race '
		+ ' change:ma_max change:ma_adj'
		+ ' change:repeating_weapons remove:repeating_weapons'
		+ ' change:repeating_armor remove:repeating_armor'
		+ ' change:repeating_equipment remove:repeating_equipment'
		+ ' change:dx_max change:dx_adj', function() {
		let totalWeight = 0;
		let totalCallbacks = 0; // how many times called back.
		let dexPenalty = 0;

		let computeAll = function() {
			getAttrs(['st', 'race', 'ma_max', 'ma_adj', 'dx_max', 'dx_adj'], function(v) {
				let strength = parseInt(v.st)||0;
				if (v.race) {
					let race = v.race.toLowerCase();
					if (race.includes('dwarf') || race.includes('dwarven')) {
						strength *= 2;
					}
				}

				let finalDex = (parseInt(v.dx_max)||0) + (parseInt(v.dx_adj)||0) - dexPenalty;
				let penalty = 'lbs, ';
				let finalMA = (parseInt(v.ma_max)||0) + (parseInt(v.ma_adj)||0);
				if (totalWeight <= 2 * strength) {
					penalty += 'no movement penalty';
				} else if (totalWeight <= 3 * strength) {
					penalty += 'swim at DX -2';
				} else if (totalWeight <= 4 * strength) {
					penalty += 'swim at DX -5';
				} else if (totalWeight <= 6 * strength) {
					penalty += "no swim, MA = 8";
					finalMA = Math.min(8, finalMA);
				} else if (totalWeight < 8 * strength) {
					penalty += 'MA = 6, DX -1';
					finalMA = Math.min(6, finalMA);
					finalDex -= 1;
				} else if (totalWeight < 10 * strength) {
					penalty += 'MA = 4, DX -2';
					finalMA = Math.min(4, finalMA);
					finalDex -= 2;
				} else {
					penalty += 'MA = 4, DX -2, movement severely impaired, see manual.'
					finalMA = Math.min(4, finalMA);
					finalDex -= 2;
				}
				setAttrs({
					weightcarried: totalWeight,
					ma: finalMA,
					mapenalty: penalty,
					dx: finalDex
				});
			});
		};

		let dexCallback = function(attrs, idarray, repName, dexPenaltyName, countName, notCarriedName) {
			dexPenalty = computeRepeatingTotal(attrs, idarray, repName, dexPenaltyName, countName, notCarriedName);
			if (++totalCallbacks == 4) {
				computeAll();
			}
		}

		let idCallback = function(attrs, idarray, repName, weightName, countName, notCarriedName) {
			totalWeight += computeRepeatingTotal(attrs, idarray, repName, weightName, countName, notCarriedName);

			if (++totalCallbacks == 4) {
				computeAll();
			}
		}

		getSectionIDs("weapons", function(v) {grabIds(v, 'weapons', 'weight', '', 'notcarried', idCallback);});
		getSectionIDs("armor", function(v) {grabIds(v, 'armor', 'weight', '', 'notcarried', idCallback);});
		getSectionIDs("equipment", function(v) {grabIds(v, 'equipment', 'weight', 'count', 'notcarried', idCallback);});

		getSectionIDs("armor", function(v) {grabIds(v, 'armor', 'dexpenalty', '', 'notcarried', dexCallback);});
	});

	// Update unspent iq points.
	on('sheet:opened '
		+ 'change:repeating_talents remove:repeating_talents '
		+ 'change:repeating_spells remove:repeating_spells '
		+ 'change:iq_max ', function() {
		let totalSpent = 0;
		let totalCallbacks = 0; // number of times called back.

		let idCallback = function(attrs, idarray, repName, costName) {
			totalSpent += computeRepeatingTotal(attrs, idarray, repName, costName);
			if (++totalCallbacks == 2) {
				getAttrs(['iq_max'], function(v) {
					let unspent = v.iq_max - totalSpent;
					setAttrs({
						iqunspent: unspent
					});
				});
			}
		}

		getSectionIDs("talents", function(v) {grabIds(v, 'talents', 'talentcost', '', '', idCallback);});
		getSectionIDs("spells", function(v) {grabIds(v, 'spells', 'spellcost', '', '', idCallback);});
	});


	/* Funny stuff with journals */
	const buttonlist = ["character","journal"];
	buttonlist.forEach(button => {
		on(`clicked:${button}`, function() {
			setAttrs({
				sheetTab: button
			});
		});
	});
</script>
